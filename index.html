<!DOCTYPE html>
<meta charset="utf-8">
<title>!? WHERE TO LIVE ?! </title>
<head>
  <link id= 'css_link' rel='stylesheet' type='text/css' href='css/style2.css'>
</head>

<body>
  <h1>Where To Live</h1>
  <p>Blah Blah Blah</p>

  <div id="container"></div>
  <div id="measure"></div>
<script src="js/d3.min.js"></script>
<script src="js/topojson.v1.min.js"></script>
<script>



var colorcode=
["#a50026","#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850","#006837"]

var oecd= [
  "Australia",
  "Austria",
  "Belgium",
  "Canada",
  "Czech Republic",
  "Denmark",
  "Finland",
  "France",
  "Germany",
  "Greece",
  "Hungary",
  "Iceland",
  "Ireland",
  "Italy",
  "Japan",
  "Korea, Republic of",
  "Luxembourg",
  "Mexico",
  "Netherlands",
  "New Zealand",
  "Norway",
  "Poland",
  "Portugal",
  "Slovakia",
  "Spain",
  "Sweden",
  "Switzerland",
  "Turkey",
  "United Kingdom",
  "United States",
  "Brazil",
  "Chile",
  "Estonia",
  "Israel",
  "Russian Federation",
  "Slovenia"
]


d3.select(window).on("resize", throttle);

var zoom = d3.behavior.zoom()
    .scaleExtent([1, 9])
    .on("zoom", move);

var height = document.getElementById('container').offsetHeight;
var width = height * 2;

var topo,projection,path,svg,g;

var graticule = d3.geo.graticule();

var tooltip = d3.select("#container").append("div").attr("class", "tooltip hidden");

setup(width,height);


function setup(width,height){
  projection = d3.geo.mercator()
    .translate([(width/2), (height/2)])
    .scale( width / 2 / Math.PI);

  path = d3.geo.path().projection(projection);

  console.log("height: "+height);
  svg = d3.select("#container").append("svg")
      .attr("width", width)
      .attr("height", height)
      .call(zoom)
      .on("click", click)
      .append("g");

  g = svg.append("g");

}

var boxData=
[
    {"rx":100, "ry":110, "height": 30, "width":30, "color":"blue"}
];


var m_height= document.getElementById('measure').offsetHeight;
var m_width=m_height*2;

var m_svg, m_g, rectangles, rectangleAttributes;

function measure_setup(w, h){
  m_svg= d3.select("#measure").append("svg")
    .attr("width", w)
    .attr("height",h);
  m_g= m_svg.append("g");
  rectangles= m_g.selectAll("rect")
    .data(boxData)
    .enter()
    .append("rect");
  rectangleAttributes = rectangles.attr("x", function (d) { return d.rx; })
    .attr("y", function (d) { return d.ry; })
    .attr("height", function (d) { return d.height; })
    .attr("width", function (d) { return d.width; })
    .style("fill", function(d) { return d.color; });
}

measure_setup(m_width, m_height);

var slider = d3.select("#measure").append("p").append("input")
  .attr("type", "range")
  .attr("value", 0)
  .attr("id", "slider")
  .on("input", function(){
      console.log(this.value);
      update(this.value);
    });

function update(slider_value){
  d3.select("#slider").attr("value", slider_value);
}

//slider 
/*
s_width= m_svg.attr("width")- 20;
s_height= m_svg.attr("height");
s_margin= {right:10, left: 10};

var slide_x = d3.scale.linear()
    .domain([0, 1])
    .range([0, s_width])
    .clamp(true);

var drag = d3.behavior.drag()
    .origin(function(d) { return d; })
    .on("dragstart", dragstarted)
    .on("drag", dragged)
    .on("dragend", dragended);

var slider = m_svg.append("g")
    .attr("class", "slider")
    .attr("transform", "translate(" + s_margin.left + "," + s_height / 2 + ")");

slider.append("line")
    .attr("class", "track")
    .attr("x1", slide_x.range()[0])
    .attr("x2", slide_x.range()[1])
  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "track-inset")
  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "track-overlay")
    .call(d3.behavior.drag()
        .on("start.interrupt", function() { slider.interrupt(); })
        .on("start drag", function() { hue(slide_x.invert(d3.event.slide_x)); }));

slider.insert("g", ".track-overlay")
    .attr("class", "ticks")
    .attr("transform", "translate(0," + 18 + ")")
  .selectAll("text")
  .data(slide_x.ticks(10))
  .enter().append("text")
    .attr("x", slide_x)
    .attr("text-anchor", "middle")
    .text(function(d) { return d + "Â°"; });

var handle = slider.insert("circle", ".track-overlay")
    .attr("class", "handle")
    .attr("r", 9);

slider.transition() // Gratuitous intro!
    .duration(750)
    .tween("hue", function() {
      var i = d3.interpolate(0, 70);
      return function(t) { hue(i(t)); };
    });

function hue(h) {
  handle.attr("cx", slide_x(h));
  m_svg.style("background-color", d3.hsl(h, 0.8, 0.8));
}



var zoom = d3.behavior.zoom()
    .scaleExtent([1, 10])
    .on("zoom", zoomed);

var slider = d3.select("body").append("p").append("input")
  .datum({})
  .attr("type", "range")
  .attr("value", zoom.scaleExtent()[0])
  .attr("min", zoom.scaleExtent()[0])
  .attr("max", zoom.scaleExtent()[1])
  .attr("step", (zoom.scaleExtent()[1] - zoom.scaleExtent()[0]) / 100)
  .on("input", slided);

var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.right + ")")
    .call(zoom);

function slided(d){
  zoom.scale(d3.select(this).property("value"))
    .event(svg);
}
*/
d3.json("data/world-topo-min.json", function(error, world) {
  var countries = topojson.feature(world, world.objects.countries).features;
  topo = countries;
  draw(topo);
});

Array.prototype.contains = function(element) {
	for (var i = 0; i < this.length; i++) {
		if (this[i] == element) {
			return true;
		}
	}
	return false;
}

function score(cname){
}

//draw the map
function draw(topo) {

  var c=0;
  svg.append("path")
     .datum(graticule)
     .attr("class", "graticule")
     .attr("d", path);


  g.append("path")
   .datum({type: "LineString", coordinates: [[-180, 0], [-90, 0], [0, 0], [90, 0], [180, 0]]})
   .attr("class", "equator")
   .attr("d", path);


  var country = g.selectAll(".country").data(topo);

  country.enter().insert("path")
      .attr("class", "country")
      .attr("d", path)
      .attr("id", function(d,i) { return d.id; })
      .attr("title", function(d,i) { return d.properties.name; })
      .style("fill", function(d, i) { 
        if(oecd.contains(d.properties.name)) {
          c=c+1;
          //console.log(d.properties.name);
          return d.properties.color;
        }
        else return "#f0f8ff";
      })
  .style("stroke", function(d){
    if(oecd.contains(d.properties.name)) {
      return "none";
    }
    else return "#aaa";
  })

  console.log(c);
  //offsets for tooltips
  var offsetL = document.getElementById('container').offsetLeft+20;
  var offsetT = document.getElementById('container').offsetTop+10;

  //tooltips
  country
    .on("mousemove", function(d,i) {

      var mouse = d3.mouse(svg.node()).map( function(d) { return parseInt(d); } );

      tooltip.classed("hidden", false)
             .attr("style", "left:"+(mouse[0]+offsetL)+"px;top:"+(mouse[1]+offsetT)+"px")
             .html(d.properties.name);

      })
      .on("mouseout",  function(d,i) {
        tooltip.classed("hidden", true);
      }); 
}

function redraw() {
  height = document.getElementById('container').offsetHeight;
  console.log("height: "+height);
  width = height * 2;
  d3.select('svg').remove();
  setup(width,height);
  draw(topo);
}


function move() {

  var t = d3.event.translate;
  var s = d3.event.scale; 
  zscale = s;
  var h = height/4;


  t[0] = Math.min(
    (width/height)  * (s - 1), 
    Math.max( width * (1 - s), t[0] )
  );

  t[1] = Math.min(
    h * (s - 1) + h * s, 
    Math.max(height  * (1 - s) - h * s, t[1])
  );

  zoom.translate(t);
  g.attr("transform", "translate(" + t + ")scale(" + s + ")");

  //adjust the country hover stroke width based on zoom level
  d3.selectAll(".country").style("stroke-width", 1.5 / s);

}



var throttleTimer;
function throttle() {
  window.clearTimeout(throttleTimer);
    throttleTimer = window.setTimeout(function() {
      redraw();
    }, 200);
}


//geo translation on mouse click in map
function click() {
  var latlon = projection.invert(d3.mouse(this));
  console.log(latlon);
}


//function to add points and text to the map (used in plotting capitals)
function addpoint(lat,lon,text) {

  var gpoint = g.append("g").attr("class", "gpoint");
  var x = projection([lat,lon])[0];
  var y = projection([lat,lon])[1];

  gpoint.append("svg:circle")
        .attr("cx", x)
        .attr("cy", y)
        .attr("class","point")
        .attr("r", 1.5);

  //conditional in case a point has no associated text
  if(text.length>0){

    gpoint.append("text")
          .attr("x", x+2)
          .attr("y", y+2)
          .attr("class","text")
          .text(text);
  }

}
</script>
</body>
</html>
